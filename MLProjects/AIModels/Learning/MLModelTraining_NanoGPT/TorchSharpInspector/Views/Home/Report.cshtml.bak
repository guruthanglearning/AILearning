@model TorchSharpInspector.Models.InspectorReport
@{
    ViewData["Title"] = "Inspection Report";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="section-title">
                    <i class="fas fa-chart-line me-3"></i>Model Inspection Report
                </h1>
                <p class="text-muted mb-0">
                    Generated on @Model.GeneratedAt.ToString("MMM dd, yyyy 'at' HH:mm:ss UTC")
                </p>
            </div>
            <div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="exportReport('json')">
                        <i class="fas fa-download me-2"></i>Export JSON
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="exportReport('csv')">
                        <i class="fas fa-file-csv me-2"></i>Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Overview -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="metric-card @(Model.CheckpointInfo.IsValidCheckpoint ? "bg-success" : "bg-danger")">
            <div class="metric-value">
                <i class="fas @(Model.CheckpointInfo.IsValidCheckpoint ? "fa-check-circle" : "fa-times-circle")"></i>
            </div>
            <div class="metric-label">Checkpoint Status</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">@Model.ArchitectureInfo.TotalParameters.ToString("N0")</div>
            <div class="metric-label">Total Parameters</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">@Model.BenchmarkResults.TokensPerSecond.ToString("F1")</div>
            <div class="metric-label">Tokens/Second</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="metric-card">
            <div class="metric-value">@Model.MemoryAnalysis.ModelSizeMB MB</div>
            <div class="metric-label">Model Size</div>
        </div>
    </div>
</div>

<!-- Warnings and Recommendations -->
@if (Model.Warnings.Any() || Model.Recommendations.Any())
{
    <div class="row mb-4">
        @if (Model.Warnings.Any())
        {
            <div class="col-lg-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Warnings</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var warning in Model.Warnings)
                        {
                            <div class="warning-item">
                                <i class="fas fa-exclamation-circle text-warning me-2"></i>@warning
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
        
        @if (Model.Recommendations.Any())
        {
            <div class="col-lg-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Recommendations</h5>
                    </div>
                    <div class="card-body">
                        @foreach (var recommendation in Model.Recommendations)
                        {
                            <div class="recommendation-item">
                                <i class="fas fa-check-circle text-info me-2"></i>@recommendation
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>
}

<!-- Detailed Analysis Tabs -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="analysisTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button">
                    <i class="fas fa-desktop me-2"></i>System Info
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="checkpoint-tab" data-bs-toggle="tab" data-bs-target="#checkpoint" type="button">
                    <i class="fas fa-file-alt me-2"></i>Checkpoint
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="architecture-tab" data-bs-toggle="tab" data-bs-target="#architecture" type="button">
                    <i class="fas fa-sitemap me-2"></i>Architecture
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">
                    <i class="fas fa-tachometer-alt me-2"></i>Performance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory" type="button">
                    <i class="fas fa-memory me-2"></i>Memory
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tensor-tab" data-bs-toggle="tab" data-bs-target="#tensor" type="button">
                    <i class="fas fa-cube me-2"></i>Tensor Ops
                </button>
            </li>
        </ul>

        <div class="tab-content" id="analysisTabContent">
            <!-- System Information Tab -->
            <div class="tab-pane fade show active" id="system" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>System Details</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>TorchSharp Version:</strong></td>
                                            <td>@Model.SystemInfo.TorchSharpVersion</td>
                                        </tr>
                                        <tr>
                                            <td><strong>.NET Version:</strong></td>
                                            <td>@Model.SystemInfo.DotNetVersion</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Operating System:</strong></td>
                                            <td>@Model.SystemInfo.OperatingSystem</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Processor:</strong></td>
                                            <td>@Model.SystemInfo.ProcessorName</td>
                                        </tr>
                                        <tr>
                                            <td><strong>CPU Cores:</strong></td>
                                            <td>@Model.SystemInfo.ProcessorCores</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-memory me-2"></i>Memory & GPU</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Total Memory:</strong></td>
                                            <td>@(Model.SystemInfo.TotalMemoryMB / 1024.0:F1) GB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Available Memory:</strong></td>
                                            <td>@(Model.SystemInfo.AvailableMemoryMB / 1024.0:F1) GB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>CUDA Available:</strong></td>
                                            <td>
                                                @if (Model.SystemInfo.CudaAvailable)
                                                {
                                                    <span class="badge bg-success">Yes</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">No</span>
                                                }
                                            </td>
                                        </tr>
                                        @if (Model.SystemInfo.CudaAvailable)
                                        {
                                            <tr>
                                                <td><strong>CUDA Version:</strong></td>
                                                <td>@Model.SystemInfo.CudaVersion</td>
                                            </tr>
                                        }
                                        <tr>
                                            <td><strong>Available Devices:</strong></td>
                                            <td>@string.Join(", ", Model.SystemInfo.AvailableDevices)</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Checkpoint Information Tab -->
            <div class="tab-pane fade" id="checkpoint" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-file-alt me-2"></i>File Information</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>File Path:</strong></td>
                                            <td><code>@Model.CheckpointInfo.FilePath</code></td>
                                        </tr>
                                        <tr>
                                            <td><strong>File Size:</strong></td>
                                            <td>@Model.CheckpointInfo.FileSizeMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Created Date:</strong></td>
                                            <td>@Model.CheckpointInfo.CreatedDate.ToString("MMM dd, yyyy HH:mm:ss")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Is Valid:</strong></td>
                                            <td>
                                                @if (Model.CheckpointInfo.IsValidCheckpoint)
                                                {
                                                    <span class="badge bg-success">Valid</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Invalid</span>
                                                }
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Checkpoint Type:</strong></td>
                                            <td>@Model.CheckpointInfo.CheckpointType</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Parameter Count:</strong></td>
                                            <td>@Model.CheckpointInfo.ParameterCount.ToString("N0")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-list me-2"></i>State Dictionary Keys</h6>
                                @if (Model.CheckpointInfo.StateKeys.Any())
                                {
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        <ul class="list-group list-group-flush">
                                            @foreach (var key in Model.CheckpointInfo.StateKeys.Take(20))
                                            {
                                                <li class="list-group-item py-1 px-0">
                                                    <small><code>@key</code></small>
                                                </li>
                                            }
                                            @if (Model.CheckpointInfo.StateKeys.Count > 20)
                                            {
                                                <li class="list-group-item py-1 px-0 text-muted">
                                                    <small>... and @(Model.CheckpointInfo.StateKeys.Count - 20) more keys</small>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">No state keys available</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Architecture Analysis Tab -->
            <div class="tab-pane fade" id="architecture" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-sitemap me-2"></i>Model Architecture</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Number of Layers:</strong></td>
                                            <td>@Model.ArchitectureInfo.NumLayers</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Embedding Dimension:</strong></td>
                                            <td>@Model.ArchitectureInfo.EmbeddingDim</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Number of Heads:</strong></td>
                                            <td>@Model.ArchitectureInfo.NumHeads</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Vocabulary Size:</strong></td>
                                            <td>@Model.ArchitectureInfo.VocabSize.ToString("N0")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Context Length:</strong></td>
                                            <td>@Model.ArchitectureInfo.ContextLength</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Feed Forward Dim:</strong></td>
                                            <td>@Model.ArchitectureInfo.FeedForwardDim</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Total Parameters:</strong></td>
                                            <td>@Model.ArchitectureInfo.TotalParameters.ToString("N0")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-layer-group me-2"></i>Layer Details</h6>
                                @if (Model.ArchitectureInfo.Layers.Any())
                                {
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        @foreach (var layer in Model.ArchitectureInfo.Layers.Take(10))
                                        {
                                            <div class="mb-2 p-2 bg-light rounded">
                                                <strong>Layer @layer.LayerIndex:</strong> @layer.LayerType<br />
                                                <small class="text-muted">Parameters: @layer.ParameterCount.ToString("N0")</small>
                                            </div>
                                        }
                                        @if (Model.ArchitectureInfo.Layers.Count > 10)
                                        {
                                            <p class="text-muted"><small>... and @(Model.ArchitectureInfo.Layers.Count - 10) more layers</small></p>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <p class="text-muted">No layer details available</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Tab -->
            <div class="tab-pane fade" id="performance" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-tachometer-alt me-2"></i>Performance Metrics</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Inference Time:</strong></td>
                                            <td>@Model.BenchmarkResults.InferenceTimeMs ms</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Load Time:</strong></td>
                                            <td>@Model.BenchmarkResults.LoadTimeMs ms</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tokens Per Second:</strong></td>
                                            <td>@Model.BenchmarkResults.TokensPerSecond.ToString("F2")</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Memory Usage:</strong></td>
                                            <td>@Model.BenchmarkResults.MemoryUsageMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Test Configuration:</strong></td>
                                            <td>@Model.BenchmarkResults.TestConfiguration</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Benchmark Time:</strong></td>
                                            <td>@Model.BenchmarkResults.BenchmarkTime.ToString("HH:mm:ss")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-bar me-2"></i>Performance Visualization</h6>
                                <canvas id="performanceChart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        @if (Model.BenchmarkResults.GenerationTests.Any())
                        {
                            <hr />
                            <h6><i class="fas fa-pencil-alt me-2"></i>Generation Tests</h6>
                            @foreach (var test in Model.BenchmarkResults.GenerationTests)
                            {
                                <div class="mb-3 p-3 bg-light rounded">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <strong>Prompt:</strong> "@test.Prompt"<br />
                                            <strong>Generated:</strong> @test.GeneratedText<br />
                                        </div>
                                        <div class="col-md-4">
                                            <small>
                                                <strong>Tokens:</strong> @test.TokensGenerated<br />
                                                <strong>Time:</strong> @test.GenerationTimeMs ms<br />
                                                <strong>Speed:</strong> @test.TokensPerSecond.ToString("F2") tok/s
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Memory Analysis Tab -->
            <div class="tab-pane fade" id="memory" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-memory me-2"></i>Memory Usage</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Model Size:</strong></td>
                                            <td>@Model.MemoryAnalysis.ModelSizeMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Runtime Memory:</strong></td>
                                            <td>@Model.MemoryAnalysis.RuntimeMemoryMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Peak Memory:</strong></td>
                                            <td>@Model.MemoryAnalysis.PeakMemoryMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Available Memory:</strong></td>
                                            <td>@Model.MemoryAnalysis.AvailableMemoryMB MB</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Memory Utilization:</strong></td>
                                            <td>
                                                @Model.MemoryAnalysis.MemoryUtilizationPercent.ToString("F1")%
                                                <div class="progress mt-1" style="height: 10px;">
                                                    <div class="progress-bar @(Model.MemoryAnalysis.MemoryUtilizationPercent > 80 ? "bg-danger" : Model.MemoryAnalysis.MemoryUtilizationPercent > 60 ? "bg-warning" : "bg-success")" 
                                                         style="width: @Model.MemoryAnalysis.MemoryUtilizationPercent%"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie me-2"></i>Memory Distribution</h6>
                                <canvas id="memoryChart" width="400" height="200"></canvas>
                            </div>
                        </div>

                        @if (Model.MemoryAnalysis.MemoryRecommendations.Any())
                        {
                            <hr />
                            <h6><i class="fas fa-lightbulb me-2"></i>Memory Recommendations</h6>
                            @foreach (var recommendation in Model.MemoryAnalysis.MemoryRecommendations)
                            {
                                <div class="recommendation-item">
                                    <i class="fas fa-info-circle text-info me-2"></i>@recommendation
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>

            <!-- Tensor Operations Tab -->
            <div class="tab-pane fade" id="tensor" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-cube me-2"></i>Tensor Operations</h6>
                                <table class="table table-sm">
                                    <tbody>
                                        <tr>
                                            <td><strong>Basic Operations:</strong></td>
                                            <td>
                                                @if (Model.TensorResults.BasicOperationsWorking)
                                                {
                                                    <span class="badge bg-success">Working</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Failed</span>
                                                }
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>GPU Available:</strong></td>
                                            <td>
                                                @if (Model.TensorResults.GpuAvailable)
                                                {
                                                    <span class="badge bg-success">Yes</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">No</span>
                                                }
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><strong>Supported Devices:</strong></td>
                                            <td>@string.Join(", ", Model.TensorResults.SupportedDevices)</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Test Time:</strong></td>
                                            <td>@Model.TensorResults.TestTime.ToString("HH:mm:ss")</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-stopwatch me-2"></i>Operation Timings</h6>
                                @if (Model.TensorResults.OperationTimings.Any())
                                {
                                    <table class="table table-sm">
                                        <tbody>
                                            @foreach (var timing in Model.TensorResults.OperationTimings)
                                            {
                                                <tr>
                                                    <td><code>@timing.Key</code></td>
                                                    <td>@timing.Value ms</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                }
                                else
                                {
                                    <p class="text-muted">No timing data available</p>
                                }
                            </div>
                        </div>

                        @if (Model.TensorResults.TestResults.Any())
                        {
                            <hr />
                            <h6><i class="fas fa-list-ul me-2"></i>Test Results</h6>
                            @foreach (var result in Model.TensorResults.TestResults)
                            {
                                <div class="mb-2 p-2 bg-light rounded">
                                    <i class="fas fa-check-circle text-success me-2"></i>@result
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Export functionality
        async function exportReport(format) {
            try {
                const response = await fetch(`/api/inspector/export/${format}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model)))
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = `inspector_report_${new Date().toISOString().split('T')[0]}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Export failed. Please try again.');
                }
            } catch (error) {
                alert('Error exporting report: ' + error.message);
            }
        }

        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Performance Chart
            const perfCtx = document.getElementById('performanceChart').getContext('2d');
            new Chart(perfCtx, {
                type: 'bar',
                data: {
                    labels: ['Inference Time', 'Load Time', 'Memory Usage'],
                    datasets: [{
                        label: 'Performance Metrics',
                        data: [@Model.BenchmarkResults.InferenceTimeMs, @Model.BenchmarkResults.LoadTimeMs, @Model.BenchmarkResults.MemoryUsageMB],
                        backgroundColor: ['#3498db', '#2ecc71', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Memory Chart
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            new Chart(memoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Model Size', 'Runtime Memory', 'Available Memory'],
                    datasets: [{
                        data: [@Model.MemoryAnalysis.ModelSizeMB, @Model.MemoryAnalysis.RuntimeMemoryMB, @Model.MemoryAnalysis.AvailableMemoryMB],
                        backgroundColor: ['#3498db', '#e74c3c', '#2ecc71']
                    }]
                },
                options: {
                    responsive: true
                }
            });
        });
    </script>
}